name: Build Kernel Driver & Loader

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  SOLUTION_FILE_PATH: kernelmode.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64

jobs:
  build:
    runs-on: windows-2022
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install Windows Driver Kit (WDK)
      shell: powershell
      run: |
        Write-Host "=== Installing Windows Driver Kit ==="
        
        # WDK 10.0.22621.0 (Windows 11, version 22H2)
        $wdkUrl = "https://go.microsoft.com/fwlink/?linkid=2196230"
        $wdkInstaller = "$env:TEMP\wdksetup.exe"
        
        Write-Host "Downloading WDK installer..."
        Invoke-WebRequest -Uri $wdkUrl -OutFile $wdkInstaller -UseBasicParsing
        
        Write-Host "Installing WDK (silent mode, takes 3-5 minutes)..."
        $process = Start-Process -FilePath $wdkInstaller -ArgumentList "/quiet", "/norestart", "/features", "+" -Wait -PassThru
        
        if ($process.ExitCode -eq 0) {
          Write-Host "✓ WDK installed successfully"
        } else {
          Write-Host "⚠ WDK installer exit code: $($process.ExitCode)"
        }

    - name: Verify WDK Installation
      shell: powershell
      run: |
        Write-Host "=== Verifying WDK Installation ==="
        
        $wdkIncludePath = "C:\Program Files (x86)\Windows Kits\10\Include"
        $wdkLibPath = "C:\Program Files (x86)\Windows Kits\10\Lib"
        
        if (Test-Path $wdkIncludePath) {
          Write-Host "✓ WDK Include found at: $wdkIncludePath"
          $versions = Get-ChildItem $wdkIncludePath | Select-Object -ExpandProperty Name
          Write-Host "  Available versions: $($versions -join ', ')"
          
          # Check for ntifs.h specifically
          $ntifs = Get-ChildItem -Path $wdkIncludePath -Recurse -Filter "ntifs.h" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($ntifs) {
            Write-Host "✓ ntifs.h found at: $($ntifs.FullName)"
          } else {
            Write-Host "✗ ntifs.h not found!"
          }
        } else {
          Write-Host "✗ WDK Include path not found!"
          exit 1
        }
        
        if (Test-Path $wdkLibPath) {
          Write-Host "✓ WDK Lib found at: $wdkLibPath"
        } else {
          Write-Host "✗ WDK Lib path not found!"
          exit 1
        }

    - name: Restore NuGet Packages
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: nuget restore ${{env.SOLUTION_FILE_PATH}}

    - name: Build Solution
      working-directory: ${{env.GITHUB_WORKSPACE}}
      shell: cmd
      run: |
        echo Building solution...
        msbuild /m /p:Configuration=%BUILD_CONFIGURATION% /p:Platform=%BUILD_PLATFORM% /p:PlatformToolset=v143 %SOLUTION_FILE_PATH% /v:minimal

    - name: List Build Output
      shell: powershell
      run: |
        Write-Host "`n=== Build Output Directory Contents ==="
        $outputPath = "x64\${{env.BUILD_CONFIGURATION}}"
        
        if (Test-Path $outputPath) {
          Write-Host "Output directory: $outputPath"
          Get-ChildItem -Path $outputPath -File | ForEach-Object {
            $sizeKB = [math]::Round($_.Length / 1KB, 2)
            Write-Host "  $($_.Name) - $sizeKB KB"
          }
        } else {
          Write-Host "✗ Output directory not found: $outputPath"
          Write-Host "`nSearching for build outputs..."
          Get-ChildItem -Recurse -Include *.sys,*.exe,*.dll -ErrorAction SilentlyContinue | Select-Object FullName
          exit 1
        }

    - name: Upload Driver Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kernel-driver-${{ github.sha }}
        path: |
          x64/Release/*.sys
          x64/Release/*.pdb
        if-no-files-found: error

    - name: Upload Loader Artifact
      uses: actions/upload-artifact@v4
      with:
        name: loader-executable-${{ github.sha }}
        path: |
          x64/Release/*.exe
          x64/Release/*.pdb
        if-no-files-found: warn

    - name: Create Release Package
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      shell: powershell
      run: |
        Write-Host "=== Creating Release Package ==="
        New-Item -ItemType Directory -Force -Path release-package | Out-Null
        
        # Copy drivers
        $drivers = Get-ChildItem x64\Release\*.sys -ErrorAction SilentlyContinue
        if ($drivers) {
          $drivers | ForEach-Object {
            Copy-Item $_.FullName -Destination release-package\
            Write-Host "✓ Added driver: $($_.Name)"
          }
        }
        
        # Copy loaders
        $loaders = Get-ChildItem x64\Release\*.exe -ErrorAction SilentlyContinue
        if ($loaders) {
          $loaders | ForEach-Object {
            Copy-Item $_.FullName -Destination release-package\
            Write-Host "✓ Added loader: $($_.Name)"
          }
        }
        
        # Copy README
        if (Test-Path README.md) {
          Copy-Item README.md release-package\
          Write-Host "✓ Added: README.md"
        }
        
        Write-Host "`nRelease package contents:"
        Get-ChildItem release-package\ | ForEach-Object {
          $sizeKB = [math]::Round($_.Length / 1KB, 2)
          Write-Host "  $($_.Name) - $sizeKB KB"
        }

    - name: Upload Release Package
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: actions/upload-artifact@v4
      with:
        name: release-package-${{ github.sha }}
        path: release-package/

    - name: Build Summary
      if: success()
      shell: powershell
      run: |
        Write-Host "`n=== ✓ BUILD SUCCESSFUL ==="
        Write-Host "Configuration: ${{env.BUILD_CONFIGURATION}}"
        Write-Host "Platform: ${{env.BUILD_PLATFORM}}"
        Write-Host "Commit: ${{ github.sha }}"
        Write-Host "`nArtifacts available in 'Actions' tab"
